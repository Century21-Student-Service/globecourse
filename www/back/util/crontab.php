<?phprequire '../../../config/conn.php';require '../../../vendor/autoload.php';use Aws\S3\S3Client;use PHPMailer\PHPMailer\PHPMailer;define('S3KEY', 'DVBMBX4CWPXPZ7LU75FW');define('S3SECRECT', 'Wc8v38wFH9KBjUINQsutsu00jGY+wiwgEi1I/3MTVXQ');define('S3BUCKET', 'ct21');$time = date('Y-m-d H:i:s', time() - 10*60);$sql = "select * from application where apply_time >= '{$time}' order by id desc ";$stmt = $conn->prepare($sql);$stmt->execute();$result = $stmt->fetchAll(PDO::FETCH_ASSOC);//print_r($result);$client = new S3Client([		'version' => 'latest',		'region' => 'sgp1',		'endpoint' => 'https://sgp1.digitaloceanspaces.com',		'credentials' => [		'key' => S3KEY,		'secret' => S3SECRECT,		],]);foreach ($result as $r) {	$sql = "SELECT a.id,	a.name,	a.birth,	a.comment,	a.address,	a.phone,	a.email,	a.entry_inst,	l.`level`,	l.grade,	a.apply_time,	a.ielts,	a.passport_photo AS `passport`,	a.graduated_photo AS `graduated`,	a.diploma_photo AS `diploma`,	a.scoresheet_photo AS `scoresheet`,	a.ielts_photo AS `ielts_photo`,	i.name AS `institution`,	c.name AS `course`	FROM `application` a	LEFT JOIN institution i ON i.id = a.inst_id	LEFT JOIN course c ON c.id = a.c_id	LEFT JOIN app_level l ON l.id = a.entry_level	where a.id = {$r['id']};";		$stmt = $conn->prepare($sql);	$stmt->execute();	$row = $stmt->fetch(PDO::FETCH_ASSOC);		if (!empty($row['passport'])) {		$cmd = $client->getCommand('GetObject', [				'Bucket' => S3BUCKET,				'Key' => $row['passport'],				]);		$request = $client->createPresignedRequest($cmd, '+6 days');		$row['passport'] = (string) $request->getUri();	}		if (!empty($row['graduated'])) {		$cmd = $client->getCommand('GetObject', [				'Bucket' => S3BUCKET,				'Key' => $row['graduated'],				]);		$request = $client->createPresignedRequest($cmd, '+6 days');		$row['graduated'] = (string) $request->getUri();	}		if (!empty($row['diploma'])) {		$cmd = $client->getCommand('GetObject', [				'Bucket' => S3BUCKET,				'Key' => $row['diploma'],				]);		$request = $client->createPresignedRequest($cmd, '+6 days');		$row['diploma'] = (string) $request->getUri();	}		if (!empty($row['scoresheet'])) {		$cmd = $client->getCommand('GetObject', [				'Bucket' => S3BUCKET,				'Key' => $row['scoresheet'],				]);		$request = $client->createPresignedRequest($cmd, '+6 days');		$row['scoresheet'] = (string) $request->getUri();	}		if (!empty($row['ielts_photo'])) {		$cmd = $client->getCommand('GetObject', [				'Bucket' => S3BUCKET,				'Key' => $row['ielts_photo'],				]);		$request = $client->createPresignedRequest($cmd, '+6 days');		$row['ielts_photo'] = (string) $request->getUri();	}		print_r($row);echo "\n";	$html = '<table class="table">';	$html .= "<tr><td width='200px'>申请时间：</td><td>{$row['apply_time']}</td></tr>";	$html .= "<tr><td>申请人姓名：</td><td>{$row['name']}</td></tr>";	$html .= "<tr><td>出生年月：</td><td>{$row['birth']}</td></tr>";	$html .= "<tr><td>联系电话：</td><td>{$row['phone']}</td></tr>";	$html .= "<tr><td>电子邮件：</td><td>{$row['email']}</td></tr>";	$html .= "<tr><td>申请院校：</td><td>{$row['institution']}</td></tr>";	$html .= "<tr><td>申请课程：</td><td>{$row['course']}</td></tr>";	$html .= "<tr><td>最高学历或在读年级：</td><td>{$row['level']} {$row['grade']}</td></tr>";	$html .= "<tr><td>毕业或在读院校：</td><td>{$row['entry_inst']}</td></tr>";	$html .= "<tr><td>雅思分数：</td><td>{$row['ielts']}</td></tr>";	$html .= "<tr><td>备注：</td><td>" . nl2br($row['comment']). "</td></tr>";	$html .= "<tr><td>护照：</td><td>";	if ($row['passport'] != ''){		$html .= "<a target='_blank' href='{$row['passport']}' >{$row['passport']}</a>";	}	$html .= "</td></tr>";	$html .= "<tr><td>学历毕业证书：</td><td>";	if ($row['graduated'] != ''){		$html .= "<a target='_blank' href='{$row['graduated']}' >{$row['graduated']}</a>";	}	$html .= "</td></tr>";	$html .= "<tr><td>学位证：</td><td>";	if ($row['diploma'] != ''){		$html .= "<a target='_blank' href='{$row['diploma']}' >{$row['diploma']}</a>";	}	$html .= "</td></tr>";	$html .= "<tr><td>毕业成绩单：</td><td>";	if ($row['scoresheet'] != ''){		$html .= "<a target='_blank' href='{$row['scoresheet']}' >{$row['scoresheet']}</a>";	}	$html .= "</td></tr>";	$html .= "<tr><td>雅思成绩单：</td><td>";	if ($row['ielts_photo'] != ''){		$html .= "<a target='_blank' href='{$row['ielts_photo']}' >{$row['ielts_photo']}</a>";	}	$html .= "</td></tr>";	$html .= '</table>';	$mail = new PHPMailer();	try {		//Server settings		//$mail->SMTPDebug = \PHPMailer\PHPMailer\SMTP::DEBUG_SERVER;		$mail->isSMTP();                                            // Send using SMTP		$mail->Host       = 'smtp.gmail.com';                    // Set the SMTP server to send through		$mail->SMTPAuth   = true;                                   // Enable SMTP authentication		$mail->Username   = 'noreplyglobalcourse@gmail.com';                     // SMTP username		//$mail->Password   = 'Global2022';                               // SMTP password		$mail->Password   = 'gqdyttyxndpajlqd';		$mail->SMTPSecure = 'ssl';		$mail->Port       = 465;                                    // TCP port to connect to, use 465 for `PHPMailer::ENCRYPTION_SMTPS` above		$mail->CharSet    = 'UTF-8';		$mail->Encoding   = 'base64';		//Recipients		$mail->setFrom('noreplyglobalcourse@gmail.com');		$mail->addAddress('george@ct21.com.au');     // Add a recipient		//$mail->addCC('361231134@qq.com');		$mail->addCC('info@ct21.com.au');				$mail->isHTML(true);                                  // Set email format to HTML		$mail->Subject = '新的课程申请';		$mail->Body    = $html;					$result = $mail->send();					echo "Message has been sent.\n";	} catch (\Exception $e) {		echo "Message could not be sent.\n";	}}